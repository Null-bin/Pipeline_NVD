-- 1. CRIAÇÃO DO SCHEMA E USUÁRIO
CREATE SCHEMA IF NOT EXISTS vulnerability AUTHORIZATION airflow_sec;

-- 2. SEQUÊNCIAS (Ajustadas para airflow_sec)
CREATE SEQUENCE IF NOT EXISTS vulnerability.assets_id_seq START 1 OWNER TO airflow_sec;
CREATE SEQUENCE IF NOT EXISTS vulnerability.defender_detections_id_seq START 1 OWNER TO airflow_sec;

-- 3. TABELA DE ATIVOS (Assets)
CREATE TABLE vulnerability.assets (
    id serial4 NOT NULL,
    asset_id varchar(50) UNIQUE,
    nome varchar(255),
    endereco_ip varchar(45),
    servico_vinculado varchar(150),
    descricao varchar(255),
    media_criticidade numeric(4, 2),
    CONSTRAINT assets_pkey PRIMARY KEY (id)
);
ALTER TABLE vulnerability.assets OWNER TO airflow_sec;

-- 4. TABELA PRINCIPAL (NVD CVEs)
CREATE TABLE vulnerability.nvd_cves (
    cve_id varchar(20) NOT NULL,
    descricao text,
    base_score numeric(3, 1),
    severidade varchar(20),
    vendor varchar(255),
    data_ultima_modificacao timestamp,
    data_coleta_airflow timestamp DEFAULT CURRENT_TIMESTAMP,
    json_original jsonb,
    CONSTRAINT nvd_cves_pkey PRIMARY KEY (cve_id)
);
ALTER TABLE vulnerability.nvd_cves OWNER TO airflow_sec;

-- 5. TABELA DE DETECÇÕES (Vínculo com Defender)
CREATE TABLE vulnerability.defender_detections (
    id serial4 NOT NULL,
    cve_id varchar(20) REFERENCES vulnerability.nvd_cves(cve_id),
    device_name varchar(150),
    software_name text,
    data_deteccao timestamp DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT defender_detections_pkey PRIMARY KEY (id)
);
ALTER TABLE vulnerability.defender_detections OWNER TO airflow_sec;
